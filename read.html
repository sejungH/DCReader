<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GP8PTD3TLS"></script>
    <script async src="https://accounts.google.com/gsi/client" defer></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-GP8PTD3TLS');
    </script>

    <script src="./scripts/firebaseDB.js"></script>
    <script src="./scripts/googleScript.js"></script>
    <script src="./scripts/googleAuth.js"></script>
    <script src="./scripts/seriesController.js"></script>
    <script src="./scripts/functions.js"></script>

    <link rel="icon" type="image/x-icon" href="./icons/favicon.ico">
    <meta property="og:image" content="https://www.lilyreader.online/icons/icon.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1024">
    <meta property="og:image:height" content="1024">
    <meta property="og:title" content="LILY READER">
    <meta property="og:description" content="대세는 백합 갤번역 리더기 by.LILYD3V">
    <title>LilyReader</title>

    <style>
        @font-face {
            font-family: 'RIDIBatang';
            src: url('./fonts/RIDIBatang.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        #episode-title,
        #episode-content {
            font-family: 'RIDIBatang', sans-serif;
        }

        #episode-content p {
            text-indent: 1rem;
        }

        #episode-content p:has(img) {
            text-indent: 0;
        }

        @media (max-width: 768px) {
            #episode-content img {
                width: calc(100% + 2rem);
                margin: auto -1rem;
            }
        }

        /* PC: 이미지 가운데 정렬 */
        @media (min-width: 769px) {
            #episode-content img {
                width: auto;
                max-width: 100%;
                margin: auto auto;
                display: block;
            }
        }

        #episode-content iframe,
        #episode-content embed {
            aspect-ratio: 16 / 9;
            width: 100%;
            height: 100%;
        }

        input,
        textarea,
        select {
            touch-action: manipulation;
        }

        .icon {
            width: 1.5rem;
            height: 1.5rem;
        }

        #input-font-size,
        #input-line-height,
        #input-paragraph-margin {
            width: 2rem;
            font-size: 0.8rem;
            padding-left: 0;
            padding-right: 0;
        }
    </style>
</head>

<body class="d-flex flex-column min-vh-100" data-bs-theme="dark">
    <nav class="navbar navbar-expand-md bg-primary-subtle">
        <div class="container-md">
            <a class="navbar-brand" href="./"><i class="bi bi-book-fill fs-3 me-2"></i><span class="fs-3"
                    style="font-family: 'Bebas Neue', sans-serif;">Lily Reader</span></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse mt-2 mt-md-0" id="navbarSupportedContent">
                <form class="ms-auto" role="search" onsubmit="return false;">
                    <div class="d-flex dropdown position-relative">
                        <input class="form-control" type="search" placeholder="검색" aria-label="Search"
                            autocomplete="off" oninput="showSuggestions(this.value)" size="40" />
                        <ul class="dropdown-menu dropdown-menu-dark w-100" id="autocomplete-list"
                            style="max-height: 200px; overflow-y: auto; margin-top: 2.5rem;"></ul>
                    </div>
                </form>
                <div id="login_container" class="mt-2 mt-md-0 ms-0 ms-md-3"></div>
            </div>
        </div>
    </nav>

    <div id="main-container" class="container-md mb-4">
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="./">목록</a></li>
                <li class="breadcrumb-item active w-75 text-truncate" aria-current="page" id="breadcrumb-title"></li>
            </ol>
        </nav>
        <div class="accordion my-3" id="series-list"></div>
        <div id="content-container">
            <div class="row justify-content-between py-3 border-bottom">
                <div class="col-auto">
                    <button class="btn btn-sm btn-outline-light rounded-pill px-3 prev-episode"><i
                            class="bi bi-caret-left-fill"></i>
                        이전화</button>
                </div>
                <div class="col-auto text-end">
                    <button class="btn btn-sm btn-outline-light rounded-pill px-3 next-episode">다음화 <i
                            class="bi bi-caret-right-fill"></i></button>
                </div>
            </div>
            <div class="row my-4">
                <h1 id="episode-title" class="h4 fw-bold mb-4"></h1>
                <div class="mb-4">
                    <span class="badge bg-secondary">글쓴이</span> <span id="episode-writer" class="badge me-4"></span>
                    <span class="badge bg-secondary">작성일</span> <span id="episode-date" class="badge"></span>
                </div>
                <div id="toolbar-top" class="d-flex gap-0 gap-md-5 py-2 mb-3 justify-content-center">
                    <div class="d-flex align-items-center">
                        <img src="./icons/font-size.svg" class="icon me-1">
                        <div class="input-group input-group-sm">
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="changeFontSize(-0.1)">-</button>
                            <span id="input-font-size" class="form-control text-center"></span>
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="changeFontSize(0.1)">+</button>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <img src="./icons/line-height.svg" class="icon ms-2 me-1">
                        <div class="input-group input-group-sm">
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="changeLineHeight(-0.1)">-</button>
                            <span id="input-line-height" class="form-control text-center"></span>
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="changeLineHeight(0.1)">+</button>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <img src="./icons/p-margin.svg" class="icon ms-2 me-1">
                        <div class="input-group input-group-sm">
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="changeParagraphMargin(-0.2)">-</button>
                            <span id="input-paragraph-margin" class="form-control text-center"></span>
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="changeParagraphMargin(0.2)">+</button>
                        </div>
                    </div>
                </div>
                <div id="episode-content" class="overflow-x-hidden"></div>
            </div>
            <div class="row justify-content-between pt-3 border-top">
                <div class="col-auto">
                    <button class="btn btn-sm btn-outline-light rounded-pill px-3 prev-episode"><i
                            class="bi bi-caret-left-fill"></i>
                        이전화</button>
                </div>
                <div class="col-auto text-end">
                    <button class="btn btn-sm btn-outline-light rounded-pill px-3 next-episode">다음화 <i
                            class="bi bi-caret-right-fill"></i></button>
                </div>
            </div>
        </div>
        <div id="comment-container" class="mt-4"></div>
    </div>

    <footer class="bg-secondary-subtle mt-auto">
        <div class="container-md py-4 text-center">
            <p class="text-muted mb-2">&copy; 2025 Lily Reader</p>
            <a href="mailto:lilyd3v@gmail.com" class="text-secondary"><small>버그 및 오류 제보</small></a>
        </div>
    </footer>

    <div id="spinner" class="bg-dark bg-opacity-50 position-fixed top-0 bottom-0 start-0 end-0 z-5">
        <div class="position-absolute top-50 start-50 translate-middle z-3">
            <div class="d-flex justify-content-center my-3">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('dev') && urlParams.get('dev') == "true") {
            eruda.init();
        }

        const firebaseDB = new FirebaseDB();
        const seriesId = urlParams.get('series');
        var episodeId;
        var series;
        var user = null;

        init();

        async function init() {
            user = await initUser();
            initGoogleAuth();

            document.getElementById('series-list').innerHTML = '';
            const data = await firebaseDB.readDataById(seriesId);

            if (data) {
                let episodes = [];
                for (const episodeData of data.episodes) {
                    episodes.push({ id: episodeData.id, title: episodeData.title, datetime: new Date(episodeData.datetime.seconds * 1000) });
                }
                series = { id: data.id, title: data.title, cover: data.cover, episodes: episodes };

                if (urlParams.has('episode')) {
                    episodeId = Number.parseInt(urlParams.get('episode'));
                } else {
                    episodeId = series.episodes[0].id;
                }

                await loadSeries(series);
                document.getElementById('breadcrumb-title').innerText = series.title;

                const episode = series.episodes.find(ep => ep.id === episodeId);
                if (episode) {
                    for (let td of document.getElementById(`table-${seriesId}`).querySelector(`tr[data-id="${episodeId}"]`).children) {
                        td.classList.add('bg-primary')
                        td.classList.remove('text-secondary-emphasis');
                    }

                    const content = await getContent(episodeId);
                    document.querySelector('title').innerText = `${episode.title} | Lily Reader`;
                    document.getElementById('episode-title').innerHTML = `${episode.title} <a href='${getURL(episodeId)}' target='_blank'><i class="bi bi-link-45deg"></i></a>`;
                    document.getElementById('episode-content').innerHTML = content.content;
                    document.getElementById('episode-writer').innerText = content.writer;
                    document.getElementById('episode-date').innerText = new Date(episode.datetime).toLocaleString();

                    if (content.comments.length > 0) {
                        document.getElementById('comment-container').innerHTML = `<span class='fw-bold my-2'>전체 댓글 ${content.comments.length}개</span>`;
                    }
                    content.comments.forEach(comment => {
                        const commentDiv = document.createElement('div');
                        if (comment.type === 'reply') {
                            commentDiv.className = 'card my-2 ms-4 bg-secondary-subtle';
                        } else {
                            commentDiv.className = 'card my-2';
                        }
                        commentDiv.innerHTML = `
                            <div class="card-body">
                                <span class="fw-bold">${comment.nickname}</span>
                                <p id="comment-${comment.id}" class="card-text py-2"></p>
                                <footer class="blockquote-footer mb-0">${comment.datetime}</footer>
                            </div>
                        `;
                        document.getElementById('comment-container').appendChild(commentDiv);
                        loadDcCon(comment.id, comment.comment);
                    });

                    var filteredEpisodes = series.episodes.filter(ep => ep.id > 0);
                    for (let btn of document.getElementsByClassName('prev-episode')) {
                        const episodeIndex = filteredEpisodes.findIndex(ep => ep.id === episodeId);

                        if (episodeIndex > 0) {
                            const prevEpisode = filteredEpisodes[episodeIndex - 1];
                            btn.addEventListener('click', () => {
                                window.location.href = `read.html?series=${seriesId}&episode=${prevEpisode.id}`;
                            });
                        } else {
                            btn.classList.add('disabled');
                        }

                    }

                    for (let btn of document.getElementsByClassName('next-episode')) {
                        const episodeIndex = filteredEpisodes.findIndex(ep => ep.id === episodeId);
                        if (episodeIndex < filteredEpisodes.length - 1) {
                            const nextEpisode = filteredEpisodes[episodeIndex + 1];
                            btn.addEventListener('click', () => {
                                window.location.href = `read.html?series=${seriesId}&episode=${nextEpisode.id}`;
                            });
                        } else {
                            btn.classList.add('disabled');
                        }

                    }

                    if (user && (!user.viewed || !user.viewed[seriesId] || !user.viewed[seriesId].includes(episodeId))) {
                        await firebaseDB.addViewed(user.id, seriesId, episodeId);
                    }

                    setParagraphStyle();

                } else {
                    document.querySelector('#content-container').innerHTML = `
                    <div class="w-100 text-center text-secondary my-5">
                        에피소드를 찾을 수 없습니다
                    </div>`;
                }

            } else {
                displayError(404, '해당 시리즈를 찾을 수 없습니다');
            }

            hideSpinner();
        }

        function editSeries(seriesId) {
            var series_title = document.getElementById(`series-title-${seriesId}`);
            series_title.innerHTML = `
                <div class='input-group input-group-sm'>
                    <span class='input-group-text'><i class="bi bi-pencil-fill"></i></span>
                    <input type="text" id="input-edit-series-title-${seriesId}" class='form-control' value="${series.title}" required />
                </div>`;
            series_title.innerHTML += `
                <div class='input-group input-group-sm mt-2'>
                    <span class='input-group-text'><i class="bi bi-image"></i></span>
                    <input type="url" id="input-edit-series-cover-${seriesId}" class='form-control' value="${series.cover}" onchange="previewCoverImage(this, 'series-cover-${series.id}')" />
                </div>`;
            var table = document.getElementById(`table-${seriesId}`);
            for (var icon of table.getElementsByClassName('drag-icon')) {
                icon.classList.toggle('collapse');
            }
            for (var icon of table.getElementsByClassName('delete-icon')) {
                icon.classList.toggle('collapse');
            }

            newEpisode(seriesId);

            var tfoot = table.getElementsByTagName('tfoot')[0];
            tfoot.classList.toggle('collapse');

            document.getElementById(`btn-edit-series-${seriesId}`).classList.add('collapse')
            document.getElementById(`btn-close-edit-series-${seriesId}`).classList.toggle('collapse');
            document.getElementById(`btn-save-series-${seriesId}`).classList.toggle('collapse');
            document.getElementById(`btn-delete-series-${seriesId}`).classList.toggle('collapse');

            table.querySelectorAll('tbody tr').forEach(tr => {
                tr.removeAttribute('onclick');
            });

            document.querySelectorAll('.accordion-button').forEach(button => {
                button.removeAttribute('data-bs-toggle');
            });
        }

        function closeEdit(seriesId) {
            var series_title = document.getElementById(`series-title-${seriesId}`);
            series_title.innerHTML = series.title;
            var series_cover = document.getElementById(`series-cover-${seriesId}`);
            series_cover.src = series.cover;
            document.getElementById(`btn-delete-series-${seriesId}`).classList.toggle('collapse');

            document.querySelectorAll('.accordion-button').forEach(button => {
                button.setAttribute('data-bs-toggle', 'collapse');
            });

            if (series.id === seriesId)
                loadEpisode(series);
        }

        async function saveSeries(seriesId) {
            showSpinner();
            var newTitle = document.getElementById(`input-edit-series-title-${seriesId}`).value;
            var newCover = document.getElementById(`series-cover-${seriesId}`).src;

            var newEpisodes = [];
            var tbody = document.getElementById(`table-${seriesId}`).getElementsByTagName('tbody')[0];
            var countlines = 0;
            series.episodes.forEach(ep => { if (ep.id < 0) countlines--; });
            for (let tr of tbody.getElementsByTagName('tr')) {
                if (tr.hasAttribute('data-id')) {
                    let id = tr.getAttribute('data-id');
                    series.episodes.forEach(ep => {
                        if (ep.id == id) {
                            newEpisodes.push(ep);
                        }
                    });
                } else {
                    let episodeInput = tr.querySelector('input[type="url"]');
                    if (episodeInput && episodeInput.hasAttribute('data-episode')) {
                        let json = JSON.parse(episodeInput.getAttribute('data-episode'));
                        newEpisodes.push({ id: json.id, title: json.title, datetime: new Date(json.datetime) });
                    }

                    let lineInput = tr.querySelector('input[type="text"]');
                    if (lineInput) {
                        countlines--;
                        newEpisodes.push({ id: countlines, title: DOMPurify.sanitize(lineInput.value), datetime: new Date() });
                    }
                }
            }

            await firebaseDB.updateData(series.id, { title: DOMPurify.sanitize(newTitle), cover: newCover, episodes: newEpisodes });
            hideSpinner();

            await init();
            const bsCollapse = new bootstrap.Collapse(`#flush-collapse-${seriesId}`, {
                toggle: false // 초기 상태를 유지
            });
            bsCollapse.show(); // 강제로 아코디언 열기
        }

        async function getTitle(input) {
            const url = input.value;
            const match = url.match(/https:\/\/(gall\.dcinside\.com\/|m\.dcinside\.com\/)/);

            if (match) {
                var title = input.parentElement.parentElement.children[0];
                var spinner = input.parentElement.parentElement.children[1]

                title.firstChild.innerText = "불러오는 중...";
                spinner.classList.remove('visually-hidden');
                document.getElementById(`btn-save-series-${seriesId}`).disabled = true;

                const episode = await getEpisodeFromURL(url);
                if (episode instanceof Object) {
                    title.firstChild.innerText = episode.title;
                    spinner.classList.add('visually-hidden');
                    input.setAttribute('data-episode', JSON.stringify(episode));
                } else {
                    title.firstChild.innerText = "제목을 불러오는 데 실패했습니다.";
                    spinner.classList.add('visually-hidden');
                }
                document.getElementById(`btn-save-series-${seriesId}`).disabled = false;
            }
        }

        async function deleteSeries(seriesId) {
            if (confirm(`[${series.title}] 을(를) 정말로 삭제하시겠습니까?`) == true) {
                showSpinner();
                await firebaseDB.deleteData(seriesId);
                hideSpinner();
                location.href = './';
            }
        }

        function setParagraphStyle() {
            const fontSize = localStorage.getItem('fontSize') || '1';
            const lineHeight = localStorage.getItem('lineHeight') || '2';
            const paragraphMargin = localStorage.getItem('paragraphMargin') || '1';

            document.getElementById('input-font-size').innerText = fontSize;
            document.getElementById('input-line-height').innerText = lineHeight;
            document.getElementById('input-paragraph-margin').innerText = paragraphMargin;

            document.getElementById('episode-content').style.fontSize = fontSize + 'rem';
            document.getElementById('episode-content').style.lineHeight = lineHeight + 'rem';
            document.getElementById('episode-content').style.marginTop = paragraphMargin + 'rem';
            document.getElementById('episode-content').style.marginBottom = paragraphMargin + 'rem';
        }

        function changeFontSize(delta) {
            var input = document.getElementById('input-font-size');
            let value = Math.min(2, Math.max(1, parseFloat(input.innerText) + delta));
            value = Number(value.toFixed(2));
            input.innerText = value;
            var content = document.getElementById('episode-content');
            content.querySelectorAll('p').forEach(p => {
                p.style.fontSize = value + 'rem';
            });
            localStorage.setItem('fontSize', value);
        }

        function changeLineHeight(delta) {
            var input = document.getElementById('input-line-height');
            let value = Math.min(3, Math.max(1.5, parseFloat(input.innerText) + delta));
            value = Number(value.toFixed(2));
            input.innerText = value;
            var content = document.getElementById('episode-content');
            content.querySelectorAll('p').forEach(p => {
                p.style.lineHeight = value + 'rem';
            });
            localStorage.setItem('lineHeight', value);
        }

        function changeParagraphMargin(delta) {
            var input = document.getElementById('input-paragraph-margin');
            let value = Math.min(2, Math.max(0, parseFloat(input.innerText) + delta));
            value = Number(value.toFixed(2));
            input.innerText = value;
            var content = document.getElementById('episode-content');
            content.querySelectorAll('p').forEach(p => {
                p.style.marginTop = value + 'rem';
                p.style.marginBottom = value + 'rem';
            });
            localStorage.setItem('paragraphMargin', value);
        }

    </script>
</body>

</html>