<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="./scripts/seriesController.js"></script>
    <script src="./scripts/functions.js"></script>

    <title></title>

    <style>
        @font-face {
            font-family: 'RIDIBatang';
            src: url('./fonts/RIDIBatang.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        #episode-title,
        #episode-content {
            font-family: 'RIDIBatang', sans-serif;
        }

        #episode-content p {
            margin: 0;
            text-indent: 1rem;
        }

        #episode-content p:has(img) {
            text-indent: 0;
        }

        #episode-content img {
            max-width: 100%;
            margin: 1rem 0;
        }
    </style>
</head>

<body data-bs-theme="dark">
    <nav class="navbar navbar-expand-md bg-primary-subtle">
        <div class="container-md">
            <a class="navbar-brand" href="./"><i class="bi bi-book-fill"></i> Lily Reader</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse mt-2 mt-md-0" id="navbarSupportedContent">
                <form class="ms-auto" role="search" onsubmit="return false;">
                    <div class="d-flex dropdown">
                        <input class="form-control me-2" type="search" placeholder="검색" aria-label="Search"
                            autocomplete="off" oninput="showSuggestions(this.value)" size="40" />
                        <ul class="dropdown-menu dropdown-menu-dark w-100 mt-5" id="autocomplete-list"
                            style="max-height: 200px; overflow-y: auto;"></ul>
                    </div>
                </form>
            </div>
        </div>
    </nav>

    <div class="container-md py-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="./">목록</a></li>
                <li class="breadcrumb-item active w-75 text-truncate" aria-current="page" id="breadcrumb-title"></li>
            </ol>
        </nav>
        <div class="accordion my-3" id="series-list"></div>
        <div>
            <div class="row py-3 border-bottom">
                <div class="col-3">
                    <button class="btn btn-sm btn-outline-light prev-episode">&lt; 이전화</button>
                </div>
                <div class="col-6">
                </div>
                <div class="col-3 text-end">
                    <button class="btn btn-sm btn-outline-light next-episode">다음화 &gt;</button>
                </div>
            </div>
            <div class="row my-4">
                <h1 id="episode-title" class="h4 fw-bold mb-4"></h1>
                <div class="mb-5">
                    <span class="badge bg-secondary">글쓴이</span> <span id="episode-writer" class="badge me-5"></span>
                    <span class="badge bg-secondary">작성일</span> <span id="episode-date" class="badge"></span>
                </div>
                <div id="episode-content"></div>
            </div>
            <div class="row pt-3 pb-5 border-top">
                <div class="col-3">
                    <button class="btn btn-sm btn-outline-light prev-episode">&lt; 이전화</button>
                </div>
                <div class="col-6">
                </div>
                <div class="col-3 text-end">
                    <button class="btn btn-sm btn-outline-light next-episode">다음화 &gt;</button>
                </div>
            </div>
        </div>
    </div>

    <div id="spinner" class="bg-dark bg-opacity-50 position-fixed top-0 bottom-0 start-0 end-0 z-5">
        <div class="position-absolute top-50 start-50 translate-middle z-3">
            <div class="d-flex justify-content-center my-3">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { FirebaseDB } from "./scripts/firebaseDB.mjs";

        const firebaseDB = new FirebaseDB();

        const urlParams = new URLSearchParams(window.location.search);
        const seriesId = urlParams.get('series');
        var episodeId;
        var series;

        init();

        async function init() {
            document.getElementById('series-list').innerHTML = '';
            const seriesData = await firebaseDB.readDataById(seriesId);
            series = Series.fromDict(seriesData);

            if (urlParams.has('episode')) {
                episodeId = Number.parseInt(urlParams.get('episode'));
            } else {
                episodeId = series.episodes[0].id;
            }

            await loadSeries(series);

            document.getElementById('breadcrumb-title').innerText = series.title;
            for (let td of document.getElementById(`table-${seriesId}`).querySelector(`tr[data-id="${episodeId}"]`).children) {
                td.classList.add('bg-primary')
            }
            const episode = series.episodes.find(ep => ep.id === episodeId);
            const content = await episode.getContent();
            document.querySelector('title').innerText = `${episode.title} | Lily Reader`;
            document.getElementById('episode-title').innerHTML = `${episode.title} <a href='${episode.getURL()}' target='_blank'><i class="bi bi-link-45deg"></i></a>`;
            document.getElementById('episode-content').innerHTML = content.content;
            document.getElementById('episode-writer').innerText = content.writer;
            document.getElementById('episode-date').innerText = new Date(episode.datetime).toLocaleString();

            for (let btn of document.getElementsByClassName('prev-episode')) {
                const episodeIndex = series.episodes.findIndex(ep => ep.id === episodeId);
                if (episodeIndex > 0) {
                    const prevEpisode = series.episodes[episodeIndex - 1];
                    btn.addEventListener('click', () => {
                        window.location.href = `read.html?series=${seriesId}&episode=${prevEpisode.id}`;
                    });
                } else {
                    btn.classList.add('disabled');
                }

            }

            for (let btn of document.getElementsByClassName('next-episode')) {
                const episodeIndex = series.episodes.findIndex(ep => ep.id === episodeId);
                if (episodeIndex < series.episodes.length - 1) {
                    const nextEpisode = series.episodes[episodeIndex + 1];
                    btn.addEventListener('click', () => {
                        window.location.href = `read.html?series=${seriesId}&episode=${nextEpisode.id}`;
                    });
                } else {
                    btn.classList.add('disabled');
                }

            }

            hideSpinner();
        }

        window.showSuggestions = async function (value) {
            const data = await firebaseDB.readData();
            const suggestions = data.filter(series => series.title.includes(value)).slice(0, 10);
            const list = document.getElementById('autocomplete-list');
            list.innerHTML = '';
            suggestions.forEach(series => {
                const item = document.createElement('li');
                item.innerHTML = `<a href='read.html?series=${series.id}' class='dropdown-item text-wrap'><small>${series.title}</small></a>`;
                list.appendChild(item);
            });
            if (value && suggestions.length > 0) {
                list.classList.add('show');
            } else {
                list.classList.remove('show');
            }
        }

        window.editSeries = function (seriesId) {
            var table = document.getElementById(`table-${seriesId}`);
            for (var icon of table.getElementsByClassName('drag-icon')) {
                icon.classList.toggle('collapse');
            }
            for (var icon of table.getElementsByClassName('delete-icon')) {
                icon.classList.toggle('collapse');
            }

            newEpisode(seriesId);

            var tfoot = table.getElementsByTagName('tfoot')[0];
            tfoot.classList.toggle('collapse');

            document.getElementById(`btn-edit-series-${seriesId}`).classList.add('collapse')
            document.getElementById(`btn-close-edit-series-${seriesId}`).classList.toggle('collapse');
            document.getElementById(`btn-save-series-${seriesId}`).classList.toggle('collapse');
            document.getElementById(`btn-delete-series-${seriesId}`).classList.toggle('collapse');

            table.querySelectorAll('tbody tr').forEach(tr => {
                tr.removeAttribute('onclick');
            });
        }

        window.newEpisode = function (seriesId) {
            var table = document.getElementById(`table-${seriesId}`);
            var tbody = table.getElementsByTagName('tbody')[0];
            var tr = document.createElement('tr');
            tr.innerHTML = `
            <td class="text-center align-middle handle"><i class="bi bi-list"></i></td>
            <td>
                <span class="status fst-italic text-secondary"><small>에피소드 제목</small></span>
                <span class="spinner-border spinner-border-sm visually-hidden" aria-hidden="true"></span>
                <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                    <input type="url" class="form-control" placeholder="번역글 링크" 
                        pattern="https://(gall\.dcinside\.com/mgallery/board/view/|m\.dcinside\.com/board/).*" 
                        title="URL은 https://gall.dcinside.com/mgallery/board/view/ 또는 https://m.dcinside.com/board/로 시작해야 합니다."
                        onchange="getTitle(this)" />
                </div>
            </td>
            <td class="d-none d-md-table-cell"></td>
            <td class="text-center align-middle delete-icon">
                <i class="bi bi-trash text-danger" style="cursor: pointer;" onclick="removeRow(this)"></i>
            </td>`;
            tbody.appendChild(tr);
        }

        window.removeRow = function (element) {
            var row = element.closest('tr');
            if (row) {
                row.remove();
            }
        }

        window.closeEdit = function (seriesId) {
            loadEpisode(series);
        }

        window.saveSeries = async function (seriesId) {
            showSpinner();
            var newEpisodes = [];
            var tbody = document.getElementById(`table-${seriesId}`).getElementsByTagName('tbody')[0];
            for (let tr of tbody.getElementsByTagName('tr')) {
                if (tr.hasAttribute('data-id')) {
                    let id = tr.getAttribute('data-id');
                    series.episodes.forEach(ep => {
                        if (ep.id == id) {
                            newEpisodes.push(ep.toObject());
                        }
                    });
                } else {
                    let episodeInput = tr.querySelector('input[type="url"]');
                    if (episodeInput.hasAttribute('data-episode')) {
                        newEpisodes.push(JSON.parse(episodeInput.getAttribute('data-episode')));
                    }
                }
            }

            await firebaseDB.updateData(series.id, { episodes: newEpisodes });
            hideSpinner();

            await init();
            const bsCollapse = new bootstrap.Collapse(`#flush-collapse-${seriesId}`, {
                toggle: false // 초기 상태를 유지
            });
            bsCollapse.show(); // 강제로 아코디언 열기
        }

        window.getTitle = async function (input) {
            const url = input.value;
            const match = url.match(/https:\/\/(gall\.dcinside\.com\/mgallery\/board\/view\/|m\.dcinside\.com\/board\/)/);

            if (match) {
                var title = input.parentElement.parentElement.children[0];
                var spinner = input.parentElement.parentElement.children[1]

                title.firstChild.innerText = "불러오는 중...";
                spinner.classList.remove('visually-hidden');
                document.getElementById(`btn-save-series-${seriesId}`).disabled = true;

                const episode = await Episode.fromURL(url);
                if (episode instanceof Episode) {
                    title.firstChild.innerText = episode.title;
                    spinner.classList.add('visually-hidden');
                    input.setAttribute('data-episode', JSON.stringify(episode.toObject()));
                    document.getElementById(`btn-save-series-${seriesId}`).disabled = false;
                }

            }
        }

        window.deleteSeries = async function (seriesId) {
            showSpinner();
            await firebaseDB.deleteData(seriesId);
            hideSpinner();
            await init();
        }

    </script>
</body>

</html>